<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–°–ª–æ—Ç-–º–∞—à–∏–Ω–∞ 3D</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {
      background: #000;
      color: #ffe600;
      font-family: 'Arial Rounded MT Bold', Arial, sans-serif;
      min-height: 100vh;
      margin: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
    }
    /* –ë–ª–æ–∫ –≤—Å–µ–π –∏–≥—Ä—ã */
    .game-container {
      margin-top: 40px;
      background: rgba(0,0,0,0.7);
      border-radius: 24px;
      box-shadow: 0 0 24px 2px #fff8, 0 2px 32px #000a;
      border: 2px solid #fff;
      padding: 32px 32px 24px 32px;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-width: 340px;
      max-width: 98vw;
    }
    #spin-info {
      font-size: 1.3em;
      margin-bottom: 30px;
      margin-top: 10px;
      background: rgba(0,0,0,0.25);
      border-radius: 10px;
      padding: 8px 24px;
      box-shadow: 0 2px 12px #0003;
      display: inline-block;
    }
    .slot3d {
      display: flex;
      justify-content: center;
      align-items: flex-end;
      margin-bottom: 32px;
      gap: 28px;
      perspective: 900px;
      background: rgba(0,0,0,0.5);
      border-radius: 22px;
      box-shadow: 0 0 16px 2px #fff8;
      border: 2px solid #fff;
      padding: 18px 18px 10px 18px;
    }
    .reel3d {
      width: 80px;
      height: 80px;
      background: linear-gradient(160deg, #23243a 60%, #181825 100%);
      border-radius: 22px;
      box-shadow: 0 8px 32px #000a, 0 0 0 4px #2a2a3a;
      border: 2.5px solid #393a4a;
      overflow: hidden;
      position: relative;
      transform-style: preserve-3d;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: box-shadow 0.4s;
    }
    .reel3d.win {
      box-shadow: 0 0 32px 8px #ffe600, 0 8px 32px #000a, 0 0 0 4px #ffe600;
      border-color: #ffe600;
      animation: winGlow 0.7s alternate infinite;
    }
    @keyframes winGlow {
      from { box-shadow: 0 0 32px 8px #ffe600, 0 8px 32px #000a, 0 0 0 4px #ffe600; }
      to { box-shadow: 0 0 48px 16px #ffe600, 0 8px 32px #000a, 0 0 0 4px #ffe600; }
    }
    .slot-mask {
      width: 100%;
      height: 80px;
      overflow: hidden;
      position: absolute;
      top: 0; left: 0;
      z-index: 2;
      border-radius: 22px;
      pointer-events: none;
    }
    .symbols {
      position: absolute;
      width: 100%;
      top: 0;
      left: 0;
      transition: transform 1.2s cubic-bezier(.22,1.2,.36,1);
      will-change: transform;
    }
    .symbol {
      height: 80px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.7em;
      text-shadow: 0 2px 8px #000a, 0 0 2px #fff8;
      filter: drop-shadow(0 0 6px #ffe60055);
      user-select: none;
      transition: filter 0.3s;
    }
    .symbol.win {
      filter: drop-shadow(0 0 16px #ffe600cc) drop-shadow(0 0 8px #fff);
      animation: symbolWin 0.7s alternate infinite;
    }
    @keyframes symbolWin {
      from { filter: drop-shadow(0 0 16px #ffe600cc) drop-shadow(0 0 8px #fff); }
      to { filter: drop-shadow(0 0 32px #ffe600cc) drop-shadow(0 0 16px #fff); }
    }
    #spin-btn {
      background: linear-gradient(90deg, #ffe600 0%, #fff700 100%);
      color: #222;
      border: none;
      padding: 20px 70px;
      font-size: 1.3em;
      border-radius: 16px;
      cursor: pointer;
      margin-bottom: 30px;
      margin-top: 10px;
      font-weight: bold;
      box-shadow: 0 4px 18px #fff5;
      transition: background 0.2s, transform 0.1s;
      letter-spacing: 1px;
      text-shadow: 0 1px 0 #fff8;
    }
    #spin-btn:active {
      transform: scale(0.97);
    }
    #prize {
      margin: 18px 0 0 0;
      font-size: 1.4em;
      color: #00ff99;
      min-height: 32px;
      font-weight: bold;
      text-shadow: 0 0 8px #00ff9955;
      letter-spacing: 1px;
      opacity: 0;
      transition: opacity 0.5s;
    }
    #prize.show {
      opacity: 1;
      animation: prizePop 0.7s;
    }
    @keyframes prizePop {
      0% { transform: scale(0.7); opacity: 0; }
      60% { transform: scale(1.15); opacity: 1; }
      100% { transform: scale(1); opacity: 1; }
    }
    .prize-list {
      margin-top: 36px;
      font-size: 1.15em;
      color: #ffe600;
      text-align: left;
      display: inline-block;
      line-height: 1.8;
      letter-spacing: 0.5px;
      background: rgba(0,0,0,0.18);
      border-radius: 12px;
      padding: 18px 32px 18px 24px;
      box-shadow: 0 0 16px 2px #fff8, 0 2px 18px #0002;
      border: 2px solid #fff;
    }
    .prize-list span {
      font-size: 1.3em;
      margin-right: 8px;
    }
    .end-message {
      margin-top: 30px;
      color: #fff;
      font-size: 1.25em;
      text-align: center;
      text-shadow: 0 0 8px #fff, 0 2px 0 #000;
      background: rgba(0,0,0,0.5);
      border-radius: 12px;
      padding: 18px 24px;
      box-shadow: 0 0 16px 2px #fff8;
      border: 2px solid #fff;
      max-width: 400px;
      line-height: 1.5;
      font-weight: 500;
      letter-spacing: 0.5px;
      display: none;
    }
    #claim-btn {
      display: none;
      margin-top: 20px;
      background: linear-gradient(45deg, #ffe600 0%, #ffd700 100%);
      color: #000;
      font-weight: bold;
      padding: 15px 50px;
      border: none;
      border-radius: 16px;
      cursor: pointer;
      font-size: 1.2em;
      transition: all 0.3s ease;
    }
    #claim-btn:hover {
      background: linear-gradient(45deg, #ffd700 0%, #ffcc00 100%);
      transform: translateY(-2px);
    }
    @media (max-width: 600px) {
      .game-container { min-width: 0; padding: 10px 2vw; }
      .slot3d { gap: 8px; padding: 8px 2px 4px 2px; }
      .reel3d { width: 48px; height: 70px; }
      .symbol { font-size: 1.3em; }
      #spin-btn { padding: 12px 30px; font-size: 1em; }
      .prize-list { padding: 10px 8px 10px 8px; font-size: 0.98em; }
      .slot-mask { height: 48px; border-radius: 12px; }
      .end-message { font-size: 1em; padding: 10px 6px; }
    }
  </style>
</head>
<body>
  <div class="game-container">
    <div id="spin-info">–£ –≤–∞—Å –ø–æ–ø—ã—Ç–æ–∫: 1</div>
    
    <div class="slot3d">
      <div class="reel3d" id="reel1">
        <div class="slot-mask">
          <div class="symbols" id="symbols1"></div>
        </div>
      </div>
      <div class="reel3d" id="reel2">
        <div class="slot-mask">
          <div class="symbols" id="symbols2"></div>
        </div>
      </div>
      <div class="reel3d" id="reel3">
        <div class="slot-mask">
          <div class="symbols" id="symbols3"></div>
        </div>
      </div>
    </div>
    
    <button id="spin-btn">–ö–†–£–¢–ò–¢–¨</button>
    <div id="prize">–£—Ä–∞! –í—ã –≤—ã–∏–≥—Ä–∞–ª–∏ 2.0 USDT!</div>
    <button id="claim-btn">–ó–ê–ë–†–ê–¢–¨ –ü–†–ò–ó</button>
    
    <div class="prize-list">
      <div><span>üé∞</span> 2.0 USDT</div>
      <div><span>üé∞</span> 10 LTC</div>
      <div><span>üé∞</span> 500 DOGE</div>
      <div><span>üé∞</span> 0.1 ETH</div>
      <div><span>üé∞</span> 50 XRP</div>
      <div><span>üé∞</span> 25 TON</div>
      <div><span>üé∞</span> 0.001 BTC</div>
      <div><span>üé∞</span> 0.005 BTC</div>
    </div>
    
    <div class="end-message" id="end-message">
      –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –ø—Ä–æ—à–ª–∏ –≤—Å–µ —ç—Ç–∞–ø—ã –∏ –≤—ã–∏–≥—Ä–∞–ª–∏ –≥–ª–∞–≤–Ω—ã–π –ø—Ä–∏–∑!
    </div>
  </div>

  <script>
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();
    
    console.log('Telegram WebApp –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
    console.log('initDataUnsafe:', tg.initDataUnsafe);
    console.log('initData:', tg.initData);

    const symbols = ['üé∞', 'üçÄ', 'üíé', '7Ô∏è‚É£', 'üé≤', '‚≠ê', 'üî•', 'üíé'];
    const reels = document.querySelectorAll('.reel3d');
    const symbolsContainers = document.querySelectorAll('.symbols');
    const spinBtn = document.getElementById('spin-btn');
    const claimBtn = document.getElementById('claim-btn');
    const prize = document.getElementById('prize');
    const spinInfo = document.getElementById('spin-info');
    const endMessage = document.getElementById('end-message');
    
    let attempts = 1;
    let spinning = false;

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞—Ä–∞–±–∞–Ω–æ–≤
    function initReels() {
      symbolsContainers.forEach(container => {
        container.innerHTML = '';
        for (let i = 0; i < 20; i++) {
          const symbol = document.createElement('div');
          symbol.className = 'symbol';
          symbol.textContent = symbols[i % symbols.length];
          container.appendChild(symbol);
        }
      });
    }

    initReels();

    // –§—É–Ω–∫—Ü–∏—è –≤—Ä–∞—â–µ–Ω–∏—è
    function spin() {
      if (spinning || attempts <= 0) return;
      
      spinning = true;
      attempts--;
      spinInfo.textContent = `–£ –≤–∞—Å –ø–æ–ø—ã—Ç–æ–∫: ${attempts}`;
      spinBtn.disabled = true;
      
      // –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏–π
      reels.forEach(reel => reel.classList.remove('win'));
      prize.classList.remove('show');
      claimBtn.style.display = 'none';
      
      // –ê–Ω–∏–º–∞—Ü–∏—è –≤—Ä–∞—â–µ–Ω–∏—è
      symbolsContainers.forEach((container, index) => {
        const randomSpins = 3 + Math.random() * 2;
        const finalPosition = -(Math.floor(Math.random() * 8) * 80);
        const totalDistance = randomSpins * 8 * 80 + finalPosition;
        
        container.style.transition = 'transform 2s cubic-bezier(.22,1.2,.36,1)';
        container.style.transform = `translateY(${totalDistance}px)`;
      });
      
      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã–∏–≥—Ä—ã—à–∞
      setTimeout(() => {
        const results = [];
        symbolsContainers.forEach(container => {
          const symbols = container.querySelectorAll('.symbol');
          const visibleSymbol = symbols[Math.floor(Math.random() * symbols.length)];
          results.push(visibleSymbol.textContent);
        });
        
        // –í—Å–µ–≥–¥–∞ –≤—ã–∏–≥—Ä—ã—à –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏
        reels.forEach(reel => reel.classList.add('win'));
        prize.classList.add('show');
        claimBtn.style.display = 'inline-block';
        
        spinning = false;
      }, 2000);
    }

    spinBtn.addEventListener('click', spin);

    claimBtn.addEventListener('click', async () => {
      // –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ —Å–ø–æ—Å–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å user_id
      let userId = tg.initDataUnsafe?.user?.id;
      if (!userId) {
        // Fallback: –ø—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –∏–∑ initData
        try {
          const initData = new URLSearchParams(tg.initData);
          const user = JSON.parse(decodeURIComponent(initData.get('user') || '{}'));
          userId = user.id;
        } catch (e) {
          console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å user_id –∏–∑ initData:', e);
        }
      }
      
      if (!userId) {
        alert('–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
        return;
      }

      try {
        claimBtn.disabled = true;
        claimBtn.textContent = '–û–¢–ü–†–ê–í–õ–Ø–ï–ú...';
        
        console.log('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å —Å user_id:', userId);
        
        const response = await fetch('https://shy-scene-5215.minuales.workers.dev/claim-bonus', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ user_id: userId, event: 'final_bonus_claimed' })
        });
        
        console.log('–ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç:', response.status);
        
        const result = await response.json();
        console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç:', result);
        
        if (result.success) {
          claimBtn.textContent = '–£–°–ü–ï–®–ù–û!';
          endMessage.style.display = 'block';
          setTimeout(() => {
            tg.close();
          }, 2000);
        } else {
          alert('–û—à–∏–±–∫–∞: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
          claimBtn.disabled = false;
          claimBtn.textContent = '–ó–ê–ë–†–ê–¢–¨ –ü–†–ò–ó';
        }
      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–ø—Ä–æ—Å–∞:', err);
        alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + err.message);
        claimBtn.disabled = false;
        claimBtn.textContent = '–ó–ê–ë–†–ê–¢–¨ –ü–†–ò–ó';
      }
    });
  </script>
</body>
</html>
