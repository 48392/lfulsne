const BOT_TOKEN = '8031251473:AAFuQHOYbb2_CkQfFDEUNF5bEQ5fMCnU2kA';

export default {
  async fetch(request, env, ctx) {
    // CORS preflight
    if (request.method === 'OPTIONS') {
      return new Response(null, {
        status: 204,
        headers: {
          'Access-Control-Allow-Origin': '*',
          'Access-Control-Allow-Methods': 'POST, OPTIONS, GET',
          'Access-Control-Allow-Headers': 'Content-Type, Authorization',
          'Access-Control-Max-Age': '86400',
        },
      });
    }

    // Health check
    if (request.method === 'GET') {
      return new Response(JSON.stringify({
        status: 'ok',
        message: 'Worker –¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è webhook –∑–∞–ø—Ä–æ—Å–æ–≤',
        timestamp: new Date().toISOString(),
        webhook: 'telegram_miniapp'
      }), {
        status: 200,
        headers: {
          'Content-Type': 'application/json',
          'Access-Control-Allow-Origin': '*',
        },
      });
    }

    // POST –æ–±—Ä–∞–±–æ—Ç–∫–∞
    if (request.method === 'POST') {
      try {
        const data = await request.json();
        const userId = data.user_id;
        const coins = data.coins || 0;
        const lastResult = data.last_result || 'N/A';
        const timestamp = data.timestamp || new Date().toISOString();
        if (!userId) {
          throw new Error('user_id –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ webhook –¥–∞–Ω–Ω—ã—Ö');
        }
        const userMessage = `üéâ –ë–æ–Ω—É—Å –ø–æ–ª—É—á–µ–Ω!\n\nüí∞ –ú–æ–Ω–µ—Ç—ã: ${coins}\nüé∞ –†–µ–∑—É–ª—å—Ç–∞—Ç: ${lastResult}\nüìÖ –í—Ä–µ–º—è: ${new Date(timestamp).toLocaleString('ru-RU')}`;
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        const telegramResponse = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            chat_id: parseInt(userId),
            text: userMessage,
            reply_markup: {
              inline_keyboard: [
                [
                  { text: 'üé∞ –û—Ç–∫—Ä—ã—Ç—å Mini App', web_app: { url: 'https://48392.github.io/lfulsne/first.html' } }
                ],
                [
                  { text: 'üåê telegra.ph', url: 'https://telegra.ph' }
                ]
              ]
            }
          })
        });
        const telegramResult = await telegramResponse.json();
        if (!telegramResult.ok) {
          return new Response(JSON.stringify({
            success: false,
            error: 'Telegram API error',
            details: telegramResult
          }), {
            status: 500,
            headers: {
              'Content-Type': 'application/json',
              'Access-Control-Allow-Origin': '*',
            },
          });
        }
        return new Response(JSON.stringify({
          status: 'success',
          message: 'Webhook –æ–±—Ä–∞–±–æ—Ç–∞–Ω —É—Å–ø–µ—à–Ω–æ',
          user_id: userId,
          telegram_sent: true
        }), {
          status: 200,
          headers: {
            'Content-Type': 'application/json',
            'Access-Control-Allow-Origin': '*',
          },
        });
      } catch (error) {
        return new Response(JSON.stringify({
          error: 'webhook_error',
          details: {
            message: error.message,
            timestamp: new Date().toISOString(),
            webhook: 'telegram_miniapp'
          }
        }), {
          status: 500,
          headers: {
            'Content-Type': 'application/json',
            'Access-Control-Allow-Origin': '*',
          },
        });
      }
    }

    // –ú–µ—Ç–æ–¥ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è
    return new Response(JSON.stringify({
      error: 'method_not_allowed',
      message: '–¢–æ–ª—å–∫–æ POST –∏ GET –º–µ—Ç–æ–¥—ã –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è',
      webhook: 'telegram_miniapp'
    }), {
      status: 405,
      headers: {
        'Content-Type': 'application/json',
        'Access-Control-Allow-Origin': '*',
      },
    });
  }
}; 
